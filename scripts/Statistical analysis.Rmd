---
title: "Sex-dependent response calling in Thyroptera tricolor"
subtitle: "Statistical analysis"
author: <a href="http://marceloarayasalas.weebly.com/">Marcelo Araya-Salas</a>
 &nbsp; 
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: no
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: no
fontsize: 12pt 
editor_options: 
  chunk_output_type: console
---


```{r packages, message=FALSE, warning = FALSE, echo = TRUE, eval = TRUE, include = FALSE}

# unload all non-based packages
out <- sapply(paste('package:', names(sessionInfo()$otherPkgs), sep = ""), function(x) try(detach(x, unload = FALSE, character.only = TRUE), silent = T))

## add 'developer/' to packages to be installed from github
x <- c("ggplot2", "readxl", "viridis", "MCMCglmm")

aa <- lapply(x, function(y) {
  
  # get pakage name
  pkg <- strsplit(y, "/")[[1]]
  pkg <- pkg[length(pkg)]
  
  # check if installed, if not then install 
  if (!pkg %in% installed.packages()[,"Package"])  {

      if (grepl("/", y))  devtools::install_github(y, force = TRUE) else
    install.packages(y) 
    }

  # load package
  try(require(pkg, character.only = T), silent = T)
})

```

```{r functions, eval = TRUE, echo = TRUE}

# path to project directory
knitr::opts_knit$set(root.dir = normalizePath(".."))

# fig quality
knitr::opts_chunk$set(dpi = 50, fig.width = 12) 

```

## Exploratory graphs
```{r read data, fig.height = 6}

# read data
dat <- read_excel("./data/Datos de respuestas_cap2.xlsx")

# convert to regular data frame
dat <- as.data.frame(dat)

# create new variable abou
dat$est_repr[dat$estado_repr == 0] <- "Inactivo"
dat$est_repr[dat$estado_repr == 1] <- "Activo"

# aggregate total number of calls
agg_dat <- aggregate(n_llamadas ~ ID + sexo_consulta + sexo_respuesta + est_repr, data = dat, FUN = sum)

# plot
ggplot(agg_dat, aes(fill = sexo_consulta, y = n_llamadas, x = sexo_respuesta)) +
geom_boxplot() +
  scale_fill_viridis_d(alpha = 0.7, begin = 0.4) +
theme_classic(base_size = 24) +
  labs(x = "Sexo respuesta", y = "Numero de llamadas")+
facet_wrap(~ est_repr) + ggtitle("Total de llamadas")


# create binary variable for calling
dat$n_llam_bin <- ifelse(dat$n_llamadas > 0, 1, 0)

# aggregate
agg_dat2 <- aggregate(n_llam_bin ~ ID + sexo_consulta + sexo_respuesta + est_repr, data = dat, FUN = sum)

#plot 
ggplot(agg_dat2, aes(fill = sexo_consulta, y = n_llam_bin, x = sexo_respuesta)) +
  geom_boxplot() +
  scale_fill_viridis_d(alpha = 0.7, begin = 0.4) +
  theme_classic(base_size = 24) +
  labs(x = "Sexo respuesta", y = "Cuenta de experimentos con respuesta")+
facet_wrap(~ est_repr) + ggtitle("Experimentos con respuesta")

```


## Multinomial mixed effect models (MCMCglmm)

- Including three-way interaction between 'sex response', 'sex inquiry' and 'reproductive stage', with individual ID as random effect:

```{r}

# define parmeters for MCMCglmm models
itrns <- 300000
burnin <- 3000
thin <- 1000

# prior for effect models
pr <- list(B = list(mu = rep(0, 8), V = diag(8) * (1 + pi^2/3)), R = list(V = 1, fix = 1),  G = list(G1 = list(V = 1, fix = 1)))

# run model
md <- MCMCglmm(n_llam_bin ~ sexo_respuesta:est_repr:sexo_consulta  - 1, random = ~ ID, data = dat, family = "categorical", prior = pr, verbose = FALSE, nitt = itrns, start = list(QUASI = FALSE), burnin = burnin, thin = thin)



```

# Caculating p-values:

The output contains the posterior distribution of the parameter estimates. These parameter distributions can be used to test specific hypothesis about differences between sexes/stages/inquiry sexes. Column names in `md$Sol` (solutions) refer to the combination of levels from the 3 interacting variables:

```{r, fig.height = 14}

# simplify names
colnames(md$Sol) <- gsub("sexo_respuesta|est_repr", "", colnames(md$Sol))

colnames(md$Sol)

# stack posteriors
Y <- stack(as.data.frame(md$Sol))

# plot posteriors
ggplot(Y, aes(x=values)) + 
  geom_vline(xintercept = 0, col = "red", lty = 2) +
  geom_density() + 
  labs(y = "Density", x = "Posterior") +
  facet_wrap(~ ind, ncol = 2) +
  theme_classic(base_size = 24)

```


```{r}

pvals <- round(sapply(unique(Y$ind), function(x) sum(Y$values[Y$ind ==x] <= 0) / sum(Y$ind ==x)), 3)

names(pvals) <- unique(Y$ind)

pvals
```

Estimates of the overlap of posteriors can be used a statistical significance test. For instance we can compare calling activity between sexes during the active stage:

```{r}

# p value
pvals <- pbapply::pbreplicate(10000, expr =
sum(md$Sol[sample(nrow(md$Sol)), "M:Activo:sexo_consultaH"] - md$Sol[, "H:Activo:sexo_consultaH"] < 0) / nrow(md$Sol)
)

mean(pvals)

# plot distributions
ggplot(Y[Y$ind %in% c("H:Activo:sexo_consultaH", "M:Activo:sexo_consultaH"), ], aes(x=values)) + geom_density(aes(group = ind, colour = ind, fill = ind), alpha=0.3) + 
      scale_color_viridis_d(alpha = 0.7, begin = 0.4, end = 0.8) +
    scale_fill_viridis_d(alpha = 0.7, begin = 0.4, end = 0.8) +
  labs(y = "Density", x = "Posterior") +
  theme_classic(base_size = 24)

```

Or whether males responde more to females during the reproductive stage:

```{r}

# p value
pvals <- pbapply::pbreplicate(10000, expr =
sum(md$Sol[sample(nrow(md$Sol)), "M:Activo:sexo_consultaH"] - md$Sol[, "M:Inactivo:sexo_consultaH"] < 0) / nrow(md$Sol)
)

mean(pvals)

# plot distributions
ggplot(Y[Y$ind %in% c("M:Activo:sexo_consultaM", "M:Inactivo:sexo_consultaM"), ], aes(x=values)) + geom_density(aes(group = ind, colour = ind, fill = ind), alpha=0.3) + 
    scale_color_viridis_d(alpha = 0.7, begin = 0.4, end = 0.8) +
    scale_fill_viridis_d(alpha = 0.7, begin = 0.4, end = 0.8) +
    labs(y = "Density", x = "Posterior") +
  theme_classic(base_size = 24)

```

Whether males respond more often to females during the active period:
```{r}

# p value
pvals <- pbapply::pbreplicate(10000, expr =
sum(md$Sol[sample(nrow(md$Sol)), "M:Activo:sexo_consultaH"] - md$Sol[, "M:Activo:sexo_consultaM"] < 0) / nrow(md$Sol)
)

mean(pvals)

# plot distributions
ggplot(Y[Y$ind %in% c("M:Activo:sexo_consultaH", "M:Activo:sexo_consultaM"), ], aes(x=values)) + geom_density(aes(group = ind, colour = ind, fill = ind), alpha=0.3) + 
    scale_color_viridis_d(alpha = 0.7, begin = 0.4, end = 0.8) +
    scale_fill_viridis_d(alpha = 0.7, begin = 0.4, end = 0.8) +
    labs(y = "Density", x = "Posterior") +
  theme_classic(base_size = 24)

```


Whether females respond differentially to sexes:
```{r}

# p value
pvals <- pbapply::pbreplicate(10000, expr =
sum(md$Sol[sample(nrow(md$Sol)), "H:Inactivo:sexo_consultaM"] - md$Sol[, "H:Inactivo:sexo_consultaH"] < 0) / nrow(md$Sol)
)

mean(pvals)

# plot distributions
ggplot(Y[Y$ind %in% c("H:Inactivo:sexo_consultaM", "H:Inactivo:sexo_consultaH"), ], aes(x=values)) + geom_density(aes(group = ind, colour = ind, fill = ind), alpha=0.3) + 
  geom_vline(xintercept = 0, lty = 2, col = "red") +
    scale_color_viridis_d(alpha = 0.7, begin = 0.4, end = 0.8) +
    scale_fill_viridis_d(alpha = 0.7, begin = 0.4, end = 0.8) +
    labs(y = "Density", x = "Posterior") +
  theme_classic(base_size = 24)

```


```{r}

head(dat)

dat_dups <- lapply(1:nrow(dat), function(x){
  
  Y <- dat[x, ]
  if (Y$n_llamadas > 1)
  Z <- Y[rep(1, Y$n_llamadas), ]
  Z$playback <- as.character(x)
  
  return(Z)
  
}) 


```



#### Diagnostic plots

```{r diagnostic plots for model, fig.height = 14}

plot(md$Sol)


```


### Sex discrimination using random forest

```{r}

library("warbleR")


est <- readRDS("./data/ext_sel_tab_inquiry.RDS")


est.adult <- est[est$age.class == "adults", ]


table(est.adult$sex)

tab <- table(est.adult$indiv)


sum(tab > 4)

est.adult.4 <- est.adult[est.adult$indiv %in% names(tab[tab > 4])]


table(est.adult.4$indiv, est.adult.4$sex)


sp <- specan(est.adult.4, wl = 1100)
anyNA(sp)

library(ranger)

sp$random <- rnorm(nrow(sp))


cc <- mfcc_stats(est.adult.4)



est.adult.4 <- resample_est(est.adult.4, samp.rate = 375)

xc <- xcorr(est.adult.4, wl = 1100)


dist_xc <- 1 - xc


# otro metodo de MDS (bootMDS)
xc_cmd <- cmdscale(dist_xc, k = 10)

xc_cmd <- as.data.frame(xc_cmd)


sp.cc <- cbind(sp, cc[ , -c(1, 2)], xc_cmd)

sp.cc[, -c(1, 2)] <- scale(sp.cc[, -c(1, 2)])


names(sp.cc)

anyNA(sp.cc)

sp.cc$sex <- est.adult.4$sex

# optimizar el mtry
rfm <- ranger(sex ~ ., data = sp.cc[, -c(1, 2)], num.trees = 10000, importance = "impurity")

rfm

imp <- rfm$variable.importance

imp_df <- data.frame(var = names(imp), imp = imp)

imp_df[order(- imp_df$imp), ]


table(est.adult.4$sex)
sp.cc.rand <- sp.cc

sp.cc.rand$sex <- sample(sp.cc.rand$sex)

ranger(sex ~ ., data = sp.cc.rand[, -c(1, 2)], num.trees = 10000, importance = "impurity")


for(i in unique(est.adult.4$indiv))

jck_nf <- sapply(unique(est.adult.4$indiv), function(i)
ranger(sex ~ ., data = sp.cc[est.adult.4$indiv != i, -c(1, 2)], num.trees = 10000, importance = "impurity")$prediction.error)

range(jck_nf)

```


---

<font size="4">R session information</font>

```{r session info, echo=F}

sessionInfo()

```
